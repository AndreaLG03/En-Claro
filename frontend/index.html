<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>En Claro - Ayuda Cognitiva</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons (Temporarily Disabled for Debugging) -->
    <!-- <script src="js/lucide.min.js"></script> -->
</head>

<body>
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    <div class="container" id="main-content">
        <!-- Legal Onboarding Screens -->

        <!-- 1. Welcome -->
        <div id="screen-legal-welcome" class="screen">
            <header>
                <h1>Hola, te damos la bienvenida</h1>
                <p>En Claro es tu apoyo en la comunicaci√≥n social.</p>
            </header>
            <div class="card">
                <p>Queremos que te sientas seguro/a us√°ndola.</p>
                <p>Antes de empezar, necesitamos explicarte brevemente c√≥mo funcionamos y pedirte permiso para procesar
                    tus datos.</p>
                <p>Prometemos ser claros y directos.</p>
                <button class="btn btn-primary" onclick="app.nextLegalScreen('legal-disclaimer')"
                    style="margin-top: 20px;">
                    Continuar <i data-lucide="arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- 2. Disclaimer (Not a doctor) -->
        <div id="screen-legal-disclaimer" class="screen">
            <header>
                <h1>Importante: No somos m√©dicos</h1>
            </header>
            <div class="card">
                <div
                    style="background: rgba(255, 159, 67, 0.1); padding: 15px; border-radius: 12px; border: 1px dashed var(--warning-color); margin-bottom: 20px;">
                    <h3
                        style="color: var(--warning-color); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="alert-triangle"></i> Aviso Legal
                    </h3>
                    <ul style="list-style-type: none; padding: 0;">
                        <li style="margin-bottom: 10px;">üö´ <strong>No realizamos diagn√≥sticos</strong> m√©dicos ni
                            psicol√≥gicos.</li>
                        <li style="margin-bottom: 10px;">üö´ <strong>No sustituimos</strong> a terapeutas ni
                            profesionales de la salud.</li>
                        <li>‚ÑπÔ∏è Nuestros an√°lisis son sugerencias basadas en patrones, no verdades absolutas.</li>
                    </ul>
                </div>
                <p>√ösala como una gu√≠a o "segunda opini√≥n", pero conf√≠a siempre en tu criterio final y en el de tus
                    profesionales.</p>
                <button class="btn btn-primary" onclick="app.nextLegalScreen('legal-data')" style="margin-top: 20px;">
                    Entendido <i data-lucide="check"></i>
                </button>
            </div>
        </div>

        <!-- 3. Data Usage -->
        <div id="screen-legal-data" class="screen">
            <header>
                <h1>Qu√© hacemos con tus datos</h1>
            </header>
            <div class="card">
                <ul style="padding-left: 20px; line-height: 1.6;">
                    <li style="margin-bottom: 15px;"><strong>Privacidad por dise√±o:</strong> No vendemos tus datos a
                        nadie. Nunca.</li>
                    <li style="margin-bottom: 15px;"><strong>Minimizaci√≥n:</strong> Solo procesamos lo que t√∫ nos env√≠as
                        voluntariamente en cada consulta.</li>
                    <li><strong>Seguridad:</strong> Tus datos viajan encriptados y seguros.</li>
                </ul>
                <p style="margin-top: 20px; font-size: 0.9rem; color: var(--text-muted);">Puedes usar la app con un
                    pseud√≥nimo si prefieres mantener tu identidad real reservada.</p>
                <button class="btn btn-primary" onclick="app.nextLegalScreen('legal-ai')" style="margin-top: 20px;">
                    Me parece bien <i data-lucide="thumbs-up"></i>
                </button>
            </div>
        </div>

        <!-- 4. AI Usage -->
        <div id="screen-legal-ai" class="screen">
            <header>
                <h1>C√≥mo funciona nuestra magia</h1>
            </header>
            <div class="card">
                <p>En Claro utiliza tecnolog√≠a de <strong>Inteligencia Artificial</strong> avanzada (proveedores
                    externos como Anthropic) para entender el contexto.</p>

                <div style="background: rgba(75, 108, 183, 0.1); padding: 15px; border-radius: 12px; margin: 20px 0;">
                    <p><strong>Recuerda:</strong></p>
                    <ul style="padding-left: 20px; margin-top: 10px;">
                        <li>La IA <strong>puede cometer errores</strong>.</li>
                        <li>No tiene sentimientos reales, aunque suene emp√°tica.</li>
                    </ul>
                </div>

                <button class="btn btn-primary" onclick="app.nextLegalScreen('legal-consent')"
                    style="margin-top: 20px;">
                    Comprendido <i data-lucide="brain-circuit"></i>
                </button>
            </div>
        </div>

        <!-- 5. Consent -->
        <div id="screen-legal-consent" class="screen">
            <header>
                <h1>Solo una cosa m√°s...</h1>
                <p>Necesitamos tu permiso para cumplir con la ley (RGPD).</p>
            </header>
            <div class="card">
                <div class="checkbox-group"
                    style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px;">
                    <label class="custom-checkbox"
                        style="display: flex; gap: 12px; align-items: flex-start; cursor: pointer;">
                        <input type="checkbox" id="check-data" onchange="app.checkLegalConsent()"
                            style="width: 20px; height: 20px; margin-top: 3px;">
                        <span style="font-size: 0.95rem; line-height: 1.4;">
                            <strong>Acepto el tratamiento de mis datos</strong> para el funcionamiento de la app, tal
                            como se describe en la Pol√≠tica de Privacidad. (Obligatorio)
                        </span>
                    </label>

                    <label class="custom-checkbox"
                        style="display: flex; gap: 12px; align-items: flex-start; cursor: pointer;">
                        <input type="checkbox" id="check-ai" onchange="app.checkLegalConsent()"
                            style="width: 20px; height: 20px; margin-top: 3px;">
                        <span style="font-size: 0.95rem; line-height: 1.4;">
                            <strong>Entiendo que la app usa Inteligencia Artificial</strong> y que sus respuestas son
                            sugerencias, no consejos m√©dicos. (Obligatorio)
                        </span>
                    </label>
                </div>

                <button class="btn btn-secondary btn-small" onclick="app.showScreen('privacy-policy')"
                    style="margin-bottom: 20px; font-size: 0.9rem;">
                    <i data-lucide="file-text"></i> Leer Pol√≠tica de Privacidad completa
                </button>

                <button id="btn-accept-legal" class="btn btn-primary" onclick="app.acceptLegal()" disabled
                    style="opacity: 0.6; cursor: not-allowed;">
                    Acepto y Comienzo <i data-lucide="check-circle"></i>
                </button>
            </div>
        </div>

        <!-- 6. Rights (Success) -->
        <div id="screen-legal-rights" class="screen">
            <header>
                <h1>¬°Todo listo! üöÄ</h1>
                <p>T√∫ tienes el control.</p>
            </header>
            <div class="card">
                <p>Recuerda que en cualquier momento puedes:</p>
                <ul style="padding-left: 20px; margin: 15px 0; line-height: 1.6;">
                    <li>üóëÔ∏è Borrar tu historial de an√°lisis.</li>
                    <li>üîí Retirar tu consentimiento.</li>
                    <li>üë§ Pedirnos que eliminemos tus datos.</li>
                </ul>
                <p style="font-weight: 600; color: var(--primary-color);">Tu tranquilidad y autonom√≠a son nuestra
                    prioridad.</p>

                <button class="btn btn-primary" onclick="app.finishLegalOnboarding()" style="margin-top: 30px;">
                    Empezar a usar En Claro <i data-lucide="sparkles"></i>
                </button>
            </div>
        </div>

        <!-- Privacy Policy Screen -->
        <div id="screen-privacy-policy" class="screen">
            <header>
                <h1>Pol√≠tica de Privacidad</h1>
            </header>
            <div class="card" style="max-height: 70vh; overflow-y: auto; text-align: left;">
                <div id="privacy-content" class="markdown-content">
                    <!-- Policy text will be injected here or hardcoded -->
                    <h3>1. ¬øQui√©nes somos?</h3>
                    <p>El responsable del tratamiento es Andrea Lancharro Gonz√°lez. Ubicaci√≥n: Espa√±a (UE).</p>

                    <h3>2. ¬øQu√© es En Claro?</h3>
                    <p>Una app de apoyo cognitivo. NO es un producto sanitario ni m√©dico.</p>

                    <h3>3. Datos que recogemos</h3>
                    <p>Solo lo necesario: textos/audios que env√≠as, preferencias (avatar/nombre) y datos t√©cnicos
                        b√°sicos. No pedimos datos de salud.</p>

                    <h3>4. Finalidad</h3>
                    <p>Analizar tus consultas y mejorar la app. Base legal: Tu consentimiento.</p>

                    <h3>5. Inteligencia Artificial</h3>
                    <p>Usamos proveedores como Anthropic. Compartimos solo lo necesario para el an√°lisis.</p>

                    <h3>6. Tus Derechos</h3>
                    <p>Acceso, Rectificaci√≥n, Supresi√≥n, Limitaci√≥n, Portabilidad. Cont√°ctanos para ejercerlos.</p>

                    <p style="margin-top: 20px; font-style: italic; color: var(--text-muted);">
                        Versi√≥n resumida para lectura f√°cil.
                    </p>
                </div>
                <button class="btn btn-primary" onclick="app.showScreen('legal-consent')"
                    style="position: sticky; bottom: 0; margin-top: 20px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1);">
                    <i data-lucide="arrow-left"></i> Volver al consentimiento
                </button>
            </div>
        </div>

        <!-- Registration Screen -->
        <div id="screen-registration" class="screen">
            <header>
                <h1>Crea tu perfil</h1>
                <p>Para personalizar tu experiencia en En Claro.</p>
            </header>
            <div class="card profile-card">
                <div class="avatar-section">
                    <div id="reg-avatar-display" class="avatar-large">üë§</div>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px;">Elige tu avatar:</p>
                    <div class="avatar-grid">
                        <span onclick="app.selectRegAvatar('üë§')">üë§</span>
                        <span onclick="app.selectRegAvatar('üë©')">üë©</span>
                        <span onclick="app.selectRegAvatar('üë®')">üë®</span>
                        <span onclick="app.selectRegAvatar('üßë')">üßë</span>
                        <span onclick="app.selectRegAvatar('üß†')">üß†</span>
                        <span onclick="app.selectRegAvatar('‚ú®')">‚ú®</span>
                        <span onclick="app.selectRegAvatar('üåà')">üåà</span>
                        <span onclick="app.selectRegAvatar('üé®')">üé®</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="reg-name">Nombre:</label>
                    <input type="text" id="reg-name" placeholder="¬øC√≥mo te llamas?">
                </div>
                <div class="form-group">
                    <label for="reg-surname">Apellidos (opcional):</label>
                    <input type="text" id="reg-surname" placeholder="Tus apellidos">
                </div>
                <div class="form-group">
                    <label for="reg-gender">G√©nero:</label>
                    <select id="reg-gender"
                        style="width: 100%; padding: 12px; border-radius: var(--radius-sm); border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-color);">
                        <option value="" disabled selected>Selecciona una opci√≥n</option>
                        <option value="masculino">Masculino</option>
                        <option value="femenino">Femenino</option>
                        <option value="nobinario">No binario</option>
                        <option value="otro">Otro</option>
                    </select>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                        Usaremos esto para dirigirnos a ti (Bienvenido/a/e).
                    </p>
                </div>

                <button class="btn btn-primary" onclick="app.completeRegistration()" style="margin-top: 20px;">
                    Continuar <i data-lucide="arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Onboarding Screen -->
        <div id="screen-onboarding" class="screen active">
            <header>
                <h1 id="i18n-onboarding-title">Bienvenido a En Claro</h1>
                <p id="i18n-onboarding-slogan" style="font-style: italic; font-size: 1.1rem; opacity: 0.9;">Tu apoyo
                    para navegar el mundo social
                    con claridad.</p>
            </header>

            <div class="card onboarding-card">
                <div class="onboarding-sections">
                    <div class="onboarding-item">
                        <i data-lucide="message-square" class="icon-message"></i>
                        <div>
                            <h3>Entiende Mensajes</h3>
                            <p>Analiza el subtexto y la intenci√≥n real detr√°s de las palabras.</p>
                        </div>
                    </div>
                    <div class="onboarding-item">
                        <i data-lucide="book-open" class="icon-glossary"></i>
                        <div>
                            <h3>Domina Expresiones</h3>
                            <p>Descubre el origen y significado literal de frases hechas e idiomas.</p>
                        </div>
                    </div>
                    <div class="onboarding-item">
                        <i data-lucide="user-check" class="icon-roleplay"></i>
                        <div>
                            <h3>Pr√°ctica Segura</h3>
                            <p>Entrena tus habilidades sociales con nuestro simulador interactivo.</p>
                        </div>
                    </div>
                    <div class="onboarding-item">
                        <i data-lucide="calendar" class="icon-routine"></i>
                        <div>
                            <h3>Tu Energ√≠a, Tu Ritmo</h3>
                            <p>Organiza tu d√≠a seg√∫n tu bater√≠a social disponible.</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-inclusion">
                    <p>‚ôæÔ∏èüåà Esta aplicaci√≥n ha sido dise√±ada pensando en las dificultades de la <strong>comunidad
                            autista</strong>, pero <strong>todo el mundo es bienvenido</strong> a usarla para mejorar su
                        comunicaci√≥n.</p>
                </div>

                <button id="i18n-btn-start" class="btn btn-primary btn-large" onclick="app.completeOnboarding()"
                    style="margin-top: 20px;">
                    Comenzar ahora <i data-lucide="arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="screen-dashboard" class="screen">
            <header style="position: relative;">
                <div class="settings-container" style="position: absolute; right: 0; top: 15px; z-index: 100;">
                    <button onclick="app.toggleSettings()"
                        style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 10px;"
                        aria-label="Ajustes">
                        <i data-lucide="settings"></i>
                    </button>
                    <div id="settings-menu" class="settings-dropdown" style="display: none;">
                        <button onclick="app.showScreen('privacy-policy')">
                            <i data-lucide="shield"></i>
                            <span>Pol√≠tica de Privacidad</span>
                        </button>
                        <button onclick="app.resetOnboarding()">
                            <i data-lucide="info"></i>
                            <span id="settings-welcome-text">Bienvenido a En Claro</span>
                        </button>
                        <button onclick="app.toggleLanguage()">
                            <i data-lucide="languages"></i>
                            <span id="lang-toggle-text">English (Change)</span>
                        </button>
                        <button onclick="app.showScreen('profile')">
                            <i data-lucide="user"></i>
                            <span>Mi Cuenta</span>
                        </button>
                    </div>
                </div>
                <h1 id="i18n-title">En Claro</h1>
                <p id="i18n-subtitle" style="font-style: italic; font-size: 0.9rem; margin-top: -5px; opacity: 0.8;">
                    Inspirada en la
                    experiencia neurodivergente</p>
                <p>¬øQu√© quieres hacer ahora?</p>
                <div id="backend-status"
                    style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; font-size: 0.8rem; color: var(--secondary-color);">
                    <span id="status-dot" style="width: 8px; height: 8px; background: #ccc; border-radius: 50%;"></span>
                    <span id="status-text">Comprobando conexi√≥n...</span>
                </div>
            </header>
            <div class="menu-list">
                <button class="btn btn-primary btn-large menu-item" style="background: var(--grad-message); --i: 1;"
                    onclick="app.showScreen('message')" aria-label="Entender un mensaje de texto">
                    <i data-lucide="message-square"></i>
                    <span id="i18n-nav-message">Entender un mensaje</span>
                </button>
                <button class="btn btn-primary btn-large menu-item" style="background: var(--grad-audio); --i: 2;"
                    onclick="app.showScreen('audio')" aria-label="Entender un audio o grabaci√≥n">
                    <i data-lucide="mic"></i>
                    <span id="i18n-nav-audio">Entender un audio</span>
                </button>
                <button class="btn btn-primary btn-large menu-item" style="background: var(--grad-glossary); --i: 3;"
                    onclick="app.showScreen('glossary')" aria-label="Explicar una frase hecha o met√°fora">
                    <i data-lucide="book-open"></i>
                    <span id="i18n-nav-glossary">Explicar una frase</span>
                </button>
                <button class="btn btn-primary btn-large menu-item" style="background: var(--grad-response); --i: 4;"
                    onclick="app.showScreen('response')" aria-label="Ayuda para responder un mensaje">
                    <i data-lucide="send"></i>
                    <span id="i18n-nav-response">Responder un mensaje</span>
                </button>
                <button class="btn btn-primary btn-large menu-item" style="background: var(--grad-routine); --i: 5;"
                    onclick="app.showScreen('routine')" aria-label="Organizar mi rutina diaria">
                    <i data-lucide="calendar"></i>
                    <span id="i18n-nav-routine">Organizar mi d√≠a</span>
                </button>
                <button class="btn btn-primary btn-large menu-item" style="background: var(--grad-roleplay); --i: 6;"
                    onclick="app.showScreen('roleplay')" aria-label="Simulador social para practicar conversaciones">
                    <i data-lucide="user-check"></i>
                    <span id="i18n-nav-roleplay">Simulador social</span>
                </button>
                <button class="btn btn-secondary btn-large menu-item" style="--i: 7; margin-top: 10px;"
                    onclick="app.showScreen('history')" aria-label="Ver historial de an√°lisis guardados">
                    <i data-lucide="history"></i>
                    <span id="i18n-nav-history">Historial de an√°lisis</span>
                </button>
                <p
                    style="text-align: center; font-style: italic; font-size: 0.85rem; margin-top: 20px; color: var(--text-muted); opacity: 0.7;">
                    Creado por Andrea Lancharro Gonz√°lez</p>
            </div>
        </div>

        <!-- Message Analysis Screen -->
        <div id="screen-message" class="screen">
            <header>
                <h1>Entender un mensaje</h1>
                <p>Pega aqu√≠ el texto que quieres analizar.</p>
            </header>
            <div class="card">
                <div class="form-group">
                    <label for="message-input">Mensaje recibido:</label>
                    <textarea id="message-input" rows="5"
                        placeholder="Ejemplo: un mensaje de WhatsApp o un email"></textarea>
                </div>
                <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <button class="btn btn-primary" style="flex: 2;" onclick="app.analyze('message')">
                        <i data-lucide="search"></i> Analizar mensaje
                    </button>
                    <button class="btn btn-secondary"
                        style="flex: 1; border-color: var(--grad-decoder); color: var(--text-color);"
                        onclick="app.analyze('decoder', 'message-input')">
                        <i data-lucide="brain-circuit"></i> Subtexto
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="app.showScreen('dashboard')">
                    <i data-lucide="home"></i> Volver al inicio
                </button>
            </div>
        </div>

        <!-- Audio Screen -->
        <div id="screen-audio" class="screen">
            <header>
                <h1>Entender un audio</h1>
                <p>Pega aqu√≠ la transcripci√≥n del audio.</p>
            </header>
            <div class="card">
                <div class="form-group">
                    <label for="audio-input">Texto del audio:</label>
                    <textarea id="audio-input" rows="5"
                        placeholder="Escribe aqu√≠ o usa las opciones de abajo..."></textarea>
                </div>
                <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <button id="btn-record" class="btn btn-secondary" style="flex: 1;" onclick="app.toggleRecording()">
                        <i data-lucide="mic"></i> Grabar Voz
                    </button>
                    <button id="btn-attach" class="btn btn-secondary" style="flex: 1;"
                        onclick="document.getElementById('audio-file').click()">
                        <i data-lucide="paperclip"></i> Adjuntar Audio
                    </button>
                    <input type="file" id="audio-file" accept="audio/*" style="display: none;"
                        onchange="app.handleAudioUpload(this)">
                </div>
                <div id="transcription-status"
                    style="display: none; font-size: 0.9rem; color: var(--primary-color); margin-bottom: var(--spacing-sm); text-align: center; font-weight: 600;">
                    <span class="pulse"></span> Transcribiendo en tiempo real...
                </div>
                <button class="btn btn-primary" onclick="app.analyze('audio')">
                    <i data-lucide="sparkles"></i> Entender intenci√≥n
                </button>
                <button class="btn btn-secondary" onclick="app.showScreen('dashboard')">
                    <i data-lucide="home"></i> Volver al inicio
                </button>
            </div>
        </div>

        <!-- Glossary Screen -->
        <div id="screen-glossary" class="screen">
            <header>
                <h1>Explicar una frase</h1>
                <p>Escribe una expresi√≥n o frase hecha.</p>
            </header>
            <div class="card">
                <div class="form-group">
                    <label for="glossary-input">Frase a explicar:</label>
                    <input type="text" id="glossary-input" placeholder="Ejemplo: 'No es para tanto'">
                </div>
                <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <button class="btn btn-primary" style="flex: 2;" onclick="app.analyze('glossary')">
                        <i data-lucide="info"></i> Explicar frase
                    </button>
                    <button class="btn btn-secondary"
                        style="flex: 1; border-color: var(--grad-glossary); color: var(--text-color);"
                        onclick="app.analyze('translator', 'glossary-input')">
                        <i data-lucide="languages"></i> Literal
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="app.showScreen('dashboard')">
                    <i data-lucide="home"></i> Volver al inicio
                </button>
            </div>
        </div>

        <!-- Response Screen -->
        <div id="screen-response" class="screen">
            <header>
                <h1>Ayuda para responder</h1>
                <p>Pega el mensaje que te han enviado.</p>
            </header>
            <div class="card">
                <div class="form-group">
                    <label for="response-input">Mensaje recibido:</label>
                    <textarea id="response-input" rows="5"
                        placeholder="Pega aqu√≠ el mensaje que quieres responder..."></textarea>
                </div>
                <!-- Optional: Tones would go here -->
                <button class="btn btn-primary" onclick="app.analyze('response')">
                    <i data-lucide="message-square"></i> Ay√∫dame a responder
                </button>
                <button class="btn btn-secondary" onclick="app.showScreen('dashboard')">
                    <i data-lucide="home"></i> Volver al inicio
                </button>
            </div>
        </div>

        <!-- Routine Screen -->
        <div id="screen-routine" class="screen">
            <header>
                <h1>Organizar mi d√≠a</h1>
                <p>Cu√©ntame qu√© quieres hacer hoy.</p>
            </header>
            <div class="card">
                <div class="form-group">
                    <label>Mi Bater√≠a Social:</label>
                    <div class="battery-selector">
                        <div class="battery-option" onclick="app.setSocialBattery(20)" data-value="20" title="Muy baja">
                            <i data-lucide="battery-low" style="color: var(--error-color);"></i>
                        </div>
                        <div class="battery-option" onclick="app.setSocialBattery(40)" data-value="40" title="Baja">
                            <i data-lucide="battery"
                                style="color: var(--warning-color); transform: rotate(-90deg);"></i>
                        </div>
                        <div class="battery-option active" onclick="app.setSocialBattery(60)" data-value="60"
                            title="Media">
                            <i data-lucide="battery-medium" style="color: #f6d365;"></i>
                        </div>
                        <div class="battery-option" onclick="app.setSocialBattery(80)" data-value="80" title="Alta">
                            <i data-lucide="battery" style="color: #a8e063; transform: rotate(-90deg);"></i>
                        </div>
                        <div class="battery-option" onclick="app.setSocialBattery(100)" data-value="100"
                            title="Muy alta">
                            <i data-lucide="battery-full" style="color: var(--success-color);"></i>
                        </div>
                    </div>
                    <input type="hidden" id="social-battery-value" value="60">
                </div>
                <div class="form-group">
                    <label for="routine-input">Tus actividades y preferencias:</label>
                    <textarea id="routine-input" rows="5"
                        placeholder="Ejemplo: Tengo que ir al m√©dico a las 10, quiero leer por la tarde,..."></textarea>
                </div>
                <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                    <button id="btn-record-routine" class="btn btn-secondary" style="flex: 1;"
                        onclick="app.toggleRecording('routine')">
                        <i data-lucide="mic"></i> Grabar Voz
                    </button>
                    <button id="btn-attach-routine" class="btn btn-secondary" style="flex: 1;"
                        onclick="document.getElementById('audio-file-routine').click()">
                        <i data-lucide="paperclip"></i> Adjuntar Audio
                    </button>
                    <input type="file" id="audio-file-routine" accept="audio/*" style="display: none;"
                        onchange="app.handleAudioUpload(this, 'routine')">
                </div>
                <div id="transcription-status-routine"
                    style="display: none; font-size: 0.9rem; color: var(--primary-color); margin-bottom: var(--spacing-sm); text-align: center; font-weight: 600;">
                    <span class="pulse"></span> Transcribiendo rutina...
                </div>
                <button class="btn btn-primary" onclick="app.analyze('routine')">
                    <i data-lucide="clipboard-list"></i> Crear rutina
                </button>
                <button class="btn btn-secondary" onclick="app.showScreen('dashboard')">
                    <i data-lucide="home"></i> Volver al inicio
                </button>
            </div>
        </div>

        <!-- Roleplay Screen -->
        <div id="screen-roleplay" class="screen">
            <header>
                <h1>Simulador Social</h1>
                <p>Practica conversaciones en un entorno seguro.</p>
            </header>

            <div id="roleplay-selector" class="card">
                <h3 style="margin-bottom: var(--spacing-md); text-align: center;">Elige un escenario:</h3>
                <div class="scenario-grid">
                    <div class="scenario-card premium-card" onclick="app.startRoleplay('Entrevista de Trabajo')"
                        style="border: 2px solid #ffd700; background: rgba(255, 215, 0, 0.05);">
                        <div class="icon-roleplay" style="color: #ffd700;"><i data-lucide="lock"></i></div>
                        <span>Entrevista (Premium)</span>
                    </div>
                    <div class="scenario-card premium-card" onclick="app.startRoleplay('Cita M√©dica')"
                        style="border: 2px solid #ffd700; background: rgba(255, 215, 0, 0.05);">
                        <div class="icon-roleplay" style="color: #ffd700;"><i data-lucide="lock"></i></div>
                        <span>M√©dico (Premium)</span>
                    </div>
                    <div class="scenario-card" onclick="app.startRoleplay('Encuentro Social')">
                        <i data-lucide="coffee"></i>
                        <span>Cita/Amigos</span>
                    </div>
                    <div class="scenario-card" onclick="app.startRoleplay('Charla Casual')">
                        <i data-lucide="users"></i>
                        <span>Vecino/Casual</span>
                    </div>
                    <!-- New Conflict Scenario -->
                    <div class="scenario-card premium-card" onclick="app.startRoleplay('Resoluci√≥n de Conflictos')"
                        style="border: 2px solid #ffd700; background: rgba(255, 215, 0, 0.05);">
                        <div class="icon-roleplay" style="color: #ffd700;"><i data-lucide="lock"></i></div>
                        <span>Discusi√≥n/Conflicto (Premium)</span>
                    </div>
                    <!-- Premium Scenario -->
                    <div class="scenario-card premium-card" onclick="app.startRoleplay('Negociaci√≥n Salarial')"
                        style="border: 2px solid #ffd700; background: rgba(255, 215, 0, 0.05);">
                        <div class="icon-roleplay" style="color: #ffd700;"><i data-lucide="lock"></i></div>
                        <span>Negociaci√≥n (Premium)</span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="app.showScreen('dashboard')">
                    <i data-lucide="home"></i> Volver al inicio
                </button>
            </div>

            <div id="roleplay-session" class="card" style="display: none;">
                <div id="chat-container">
                    <!-- Messages will appear here -->
                </div>
                <div class="form-group" style="display: flex; gap: 8px;">
                    <input type="text" id="roleplay-input" placeholder="Escribe tu respuesta..."
                        onkeypress="if(event.key === 'Enter') app.sendRoleplayMessage()">
                    <button class="btn btn-primary" style="width: auto; margin-bottom: 0;"
                        onclick="app.sendRoleplayMessage()">
                        <i data-lucide="send"></i>
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="app.endRoleplay()"
                    style="color: var(--warning-color); border-color: var(--warning-color);">
                    <i data-lucide="check-circle"></i> Finalizar y obtener feedback
                </button>
            </div>
        </div>

    </div>

    <!-- Loading Screen -->
    <div id="screen-loading" class="screen">
        <div class="card loader">
            <div class="skeleton-title"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line short"></div>
            <div class="typing-ind" style="margin-top: 20px;">
                <span class="pulse"></span>
                <span id="loading-text" style="font-weight: 600; color: var(--primary-color);">Analizando...</span>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="screen-result" class="screen">
        <header>
            <h1>Resultado</h1>
        </header>
        <div id="result-content" class="card">
            <div id="result-skeleton" style="display: none;">
                <div class="skeleton-title"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line short"></div>
            </div>
            <div id="result-text" class="markdown-content"></div>
        </div>
        <div class="nav-footer">
            <button id="btn-result-action" class="btn btn-primary" style="display: none;">
                <i data-lucide="sparkles"></i> Hacer algo m√°s
            </button>
            <button class="btn btn-secondary" onclick="app.showScreen('dashboard')">
                <i data-lucide="home"></i> Volver al inicio
            </button>
        </div>
    </div>

    <!-- History Screen -->
    <div id="screen-history" class="screen">
        <header>
            <h1>Historial</h1>
            <p>Tus an√°lisis recientes guardados localmente.</p>
        </header>
        <div id="history-list">
            <!-- History items injected here -->
        </div>
        <div class="nav-footer">
            <button class="btn btn-secondary" onclick="app.clearHistory()"
                style="color: var(--error-color); border-color: var(--error-color);">
                <i data-lucide="trash-2"></i> Borrar Historial
            </button>
            <button class="btn btn-secondary" onclick="app.resetOnboarding()"
                style="color: var(--warning-color); border-color: var(--warning-color);">
                <i data-lucide="refresh-cw"></i> Reiniciar Bienvenida
            </button>
            <button class="btn btn-primary" onclick="app.showScreen('dashboard')">
                <i data-lucide="home"></i> Volver al inicio
            </button>
        </div>
    </div>

    <!-- Profile Screen -->
    <div id="screen-profile" class="screen">
        <header>
            <h1>Mi Cuenta</h1>
            <p>Personaliza tu experiencia en En Claro.</p>
        </header>
        <div class="card profile-card">
            <div class="avatar-section">
                <div id="current-avatar" class="avatar-large">üë§</div>
                <button class="btn btn-secondary btn-small" onclick="app.toggleAvatarPicker()">
                    Cambiar Avatar
                </button>
                <div id="avatar-picker" class="avatar-grid" style="display: none;">
                    <span onclick="app.selectAvatar('üë§')">üë§</span>
                    <span onclick="app.selectAvatar('üß†')">üß†</span>
                    <span onclick="app.selectAvatar('‚ú®')">‚ú®</span>
                    <span onclick="app.selectAvatar('üåà')">üåà</span>
                    <span onclick="app.selectAvatar('üé®')">üé®</span>
                    <span onclick="app.selectAvatar('üöÄ')">üöÄ</span>
                    <span onclick="app.selectAvatar('üêæ')">üêæ</span>
                    <span onclick="app.selectAvatar('üí°')">üí°</span>
                </div>
            </div>

            <div class="form-group">
                <label for="profile-name">Nombre:</label>
                <input type="text" id="profile-name" placeholder="Tu nombre">
            </div>
            <div class="form-group">
                <label for="profile-surname">Apellidos:</label>
                <input type="text" id="profile-surname" placeholder="Tus apellidos">
            </div>
            <div class="form-group">
                <label for="profile-gender">G√©nero:</label>
                <select id="profile-gender"
                    style="width: 100%; padding: 12px; border-radius: var(--radius-sm); border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-color);">
                    <option value="" disabled selected>Selecciona una opci√≥n</option>
                    <option value="masculino">Masculino</option>
                    <option value="femenino">Femenino</option>
                    <option value="nobinario">No binario</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label for="profile-email">Email:</label>
                <input type="email" id="profile-email" placeholder="tu@email.com">
            </div>

            <button class="btn btn-google" onclick="app.connectGoogle()">
                <i data-lucide="log-in"></i> Conectar con Google
            </button>

            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="app.saveProfile()">
                    Guardar Cambios
                </button>
                <button class="btn btn-secondary" onclick="app.showScreen('dashboard')">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Error Dialog (Simple) -->
    <div id="screen-error" class="screen">
        <div class="card" style="border-top: 5px solid var(--error-color);">
            <h3>Algo no ha salido bien</h3>
            <p id="error-message">No se pudo realizar el an√°lisis. Por favor, verifica que el backend est√© corriendo
                y que hayas configurado tu CLAUDE_API_KEY en el archivo .env.</p>
            <button class="btn btn-primary" onclick="app.showScreen('dashboard')"
                style="margin-top: var(--spacing-md);">Entendido</button>
        </div>
    </div>

    <script src="js/app_v5.js?v=115"></script>
    <!-- Lucide init moved to app_v4.js -->
</body>

</html>